version: '3'
services:
  gitlab-runner-init:
    image: gitlab/gitlab-runner:latest
    command: ["register",
              "--non-interactive",
              "--url", "https://gitlab.com/",
              "--registration-token", "yJKxq1yHVHXe3US_o4fs",
              "--executor", "docker",
              "--docker-image", "alpine:latest",
              "--description", "docker-runner",
              "--tag-list", "kubernetes",
              "--run-untagged","true",
              "--locked", "false",
              "--access-level", "not_protected"]
    restart: "no"
    volumes:
      - ./gitlab-runner:/etc/gitlab-runner
  modify-runner-config-1:
    image: busybox:latest
    command: sed -i 's|    volumes =.*|    volumes = ["/cache", "/var/run/docker.sock:/run/docker.sock"]|g' /etc/gitlab-runner/config.toml
    depends_on:
    - gitlab-runner-init
    restart: "no"
    volumes:
      - ./gitlab-runner:/etc/gitlab-runner
  modify-runner-config-2:
    image: busybox:latest
    command: sed -i '/^    volumes/a\    network_mode = "host"' /etc/gitlab-runner/config.toml
    depends_on:
    - gitlab-runner-init
    - modify-runner-config-1
    restart: "no"
    volumes:
      - ./gitlab-runner:/etc/gitlab-runner
